---
apiVersion: v1
kind: Secret
metadata:
  name: nifi-admin-credentials
stringData:
  admin: adminadmin
---
apiVersion: authentication.stackable.tech/v1alpha1
kind: AuthenticationClass
metadata:
  name: nifi-users
spec:
  provider:
    static:
      userCredentialsSecret:
        name: nifi-admin-credentials
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: caddy-config
data:
  Caddyfile: |
    {
        http_port 5000
    }

    # Strip TLS for local testing
    http://localhost {
        reverse_proxy https://nifi-node-default-0:8443 {
            transport http {
              tls_insecure_skip_verify
            }
        }
    }
---
apiVersion: nifi.stackable.tech/v1alpha1
kind: NifiCluster
metadata:
  name: nifi
spec:
  image:
    productVersion: 2.6.0
    custom: oci.stackable.tech/sandbox/nick/nifi:2.6.0-stackable0.0.0-dev-amd64
  clusterConfig:
    authentication:
      - authenticationClass: nifi-users
    sensitiveProperties:
      keySecret: nifi-sensitive-property-key
      autoGenerate: true
    extraVolumes:
      - name: nifi-processors
        persistentVolumeClaim:
          claimName: nifi-processors
  nodes:
    roleConfig:
      listenerClass: external-unstable
    configOverrides:
      nifi.properties:
        nifi.nar.library.directory.myCustomLibs: "/stackable/userdata/nifi-processors/"
        # Quicker startup
        nifi.cluster.flow.election.max.wait.time: 3 secs
        nifi.cluster.flow.election.max.candidates: "1"
        nifi.web.https.sni.host.check: "false"
        nifi.web.https.sni.required: "false"
    podOverrides:
      spec:
        volumes:
          - name: caddy-config
            configMap:
              name: caddy-config
        containers:
          # This can help when you need to port-forward because the Kubernetes Nodes (and NodePorts) are inaccessible.
          - name: reverse-proxy
            image: caddy:latest
            ports:
              - containerPort: 5000
                protocol: TCP
            volumeMounts:
              - name: caddy-config
                mountPath: /etc/caddy/
#          - name: nifi
#            env:
#              - name: AWS_ACCESS_KEY_ID
#                valueFrom:
#                  secretKeyRef:
#                    name: minio-s3-credentials
#                    key: accessKey
#              - name: AWS_SECRET_ACCESS_KEY
#                valueFrom:
#                  secretKeyRef:
#                    name: minio-s3-credentials
#                    key: secretKey
    roleGroups:
      default:
        replicas: 1
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nifi-processors
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
